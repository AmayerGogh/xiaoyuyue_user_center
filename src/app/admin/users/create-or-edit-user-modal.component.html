<div [@routerTransition]>
    <form #userForm="ngForm" novalidate (ngSubmit)="save()">
        <div class="row margin-bottom-5">
            <div class="col-xs-6">
                <div class="page-head">
                    <div class="page-title">
                        <h1>
                            <span *ngIf="getUserForEdit.user.id">{{l("EditUser")}}: {{getUserForEdit.user.userName}}</span>
                            <span *ngIf="!getUserForEdit.user.id">{{l("CreateNewUser")}}</span>
                            <small>{{l("UsersHeaderInfo")}}</small>
                        </h1>
                    </div>
                </div>
            </div>
            <div class="col-xs-6 text-right">
                <button class="btn btn-primary red" type="button" [disabled]="saving" (click)="close()"><i class="fa fa-arrow-left"></i> {{l("Back")}}</button>
                <button type="submit" class="btn btn-primary blue" [disabled]="!userForm.form.valid" [buttonBusy]="saving" [busyText]="l('SavingWithThreeDot')"><i class="fa fa-save"></i> <span>{{l("Save")}}</span></button>
            </div>
        </div>
        <div class="portlet light margin-bottom-0">
            <div class="portlet-body">
                <tabset class="tab-container tabbable-line">
                    <tab heading="{{l('UserInformations')}}">

                        <div class="row common-input-line-width">
                            <div class="col-sm-4 text-center">
                                <img src="{{getUserForEdit.profilePicture}}" width="128" height="128" class="img-thumbnail img-rounded user-edit-dialog-profile-image" />
                            </div>
                            <div class="col-sm-8">
                                <div class="form-group form-md-line-input form-md-floating-label no-hint">
                                    <input #nameInput class="form-control" type="text" name="Name" [ngClass]="{'edited':getUserForEdit.user.name}" [(ngModel)]="getUserForEdit.user.name" required maxlength="32">
                                    <label>{{l("Name")}}</label>
                                </div>

                                <div class="form-group form-md-line-input form-md-floating-label no-hint">
                                    <input type="text" name="Surname" class="form-control" [ngClass]="{'edited':getUserForEdit.user.surname}" [(ngModel)]="getUserForEdit.user.surname" required maxlength="32">
                                    <label>{{l("Surname")}}</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group form-md-line-input form-md-floating-label no-hint common-input-line-width">
                            <input type="email" name="EmailAddress" class="form-control" [ngClass]="{'edited':getUserForEdit.user.emailAddress}" [(ngModel)]="getUserForEdit.user.emailAddress" required maxlength="256" pattern="^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$">
                            <label>{{l("EmailAddress")}}</label>
                        </div>

                        <div class="form-group form-md-line-input form-md-floating-label no-hint common-input-line-width">
                            <input type="text" name="PhoneNumber" class="form-control" [ngClass]="{'edited':getUserForEdit.user.phoneNumber}" [(ngModel)]="getUserForEdit.user.phoneNumber" maxlength="24">
                            <label>{{l("PhoneNumber")}}</label>
                        </div>

                        <div class="form-group form-md-line-input form-md-floating-label common-input-line-width">
                            <input type="text" [disabled]="!canChangeUserName" [ngClass]="{'edited':getUserForEdit.user.userName}" name="UserName" class="form-control input-ltr" [(ngModel)]="getUserForEdit.user.userName" required maxlength="32">
                            <label>{{l("UserName")}}</label>
                            <span class="help-block" *ngIf="!canChangeUserName">{{l("CanNotChangeAdminUserName")}}</span>
                        </div>

                        <div class="md-checkbox-list common-input-line-width">
                            <div class="md-checkbox">
                                <input id="EditUser_SetRandomPassword" class="md-check" type="checkbox" name="SetRandomPassword" [(ngModel)]="setRandomPassword">
                                <label for="EditUser_SetRandomPassword">
                                    <span class="inc"></span>
                                    <span class="check"></span>
                                    <span class="box"></span>
                                    {{l("SetRandomPassword")}}
                                </label>
                            </div>
                        </div>

                        <ng-template #passwordComplexityInfoTemplate>
                            <div style="width: 400px;" [innerHtml]="passwordComplexityInfo"></div>
                        </ng-template>

                        <div class="form-group form-md-line-input form-md-floating-label no-hint common-input-line-width" *ngIf="!setRandomPassword">
                            <div class="input-icon right">
                                <input type="password" name="Password" #Password="ngModel" id="Password" class="form-control" [ngClass]="{'edited':user.password}" [(ngModel)]="user.password" [required]="!user.id && !setRandomPassword" maxlength="32" [requireDigit]="passwordComplexitySetting.requireDigit"
                                    [requireLowercase]="passwordComplexitySetting.requireLowercase" [requireUppercase]="passwordComplexitySetting.requireUppercase" [requireNonAlphanumeric]="passwordComplexitySetting.requireNonAlphanumeric" [requiredLength]="passwordComplexitySetting.requiredLength"
                                    validateEqual="PasswordRepeat" reverse="true">
                                <label>{{l("Password")}}</label>
                                <i class="icon-info" [popover]="passwordComplexityInfoTemplate"></i>
                            </div>
                        </div>

                        <div class="form-group form-md-line-input form-md-floating-label no-hint common-input-line-width" *ngIf="!setRandomPassword">
                            <div class="input-icon right">
                                <input type="password" name="PasswordRepeat" #PasswordRepeat="ngModel" class="form-control" [ngClass]="{'edited':user.passwordRepeat}" [(ngModel)]="user.passwordRepeat" [required]="!user.id && !setRandomPassword" maxlength="32" [requireDigit]="passwordComplexitySetting.requireDigit"
                                    [requireLowercase]="passwordComplexitySetting.requireLowercase" [requireUppercase]="passwordComplexitySetting.requireUppercase" [requireNonAlphanumeric]="passwordComplexitySetting.requireNonAlphanumeric" [requiredLength]="passwordComplexitySetting.requiredLength"
                                    validateEqual="Password" reverse="false">
                                <label>{{l("PasswordRepeat")}}</label>
                                <i class="icon-info" [popover]="passwordComplexityInfoTemplate"></i>
                            </div>
                        </div>

                        <div class="md-checkbox-list common-input-line-width">
                            <div class="md-checkbox">
                                <input id="EditUser_ShouldChangePasswordOnNextLogin" class="md-check" type="checkbox" name="ShouldChangePasswordOnNextLogin" [(ngModel)]="getUserForEdit.user.shouldChangePasswordOnNextLogin">
                                <label for="EditUser_ShouldChangePasswordOnNextLogin">
                            <span class="inc"></span>
                            <span class="check"></span>
                            <span class="box"></span>
                            {{l("ShouldChangePasswordOnNextLogin")}}
                        </label>
                            </div>
                            <div class="md-checkbox">
                                <input id="EditUser_SendActivationEmail" class="md-check" type="checkbox" name="SendActivationEmail" [(ngModel)]="sendActivationEmail">
                                <label for="EditUser_SendActivationEmail">
                            <span class="inc"></span>
                            <span class="check"></span>
                            <span class="box"></span>
                            {{l("SendActivationEmail")}}
                        </label>
                            </div>
                            <div class="md-checkbox">
                                <input id="EditUser_IsActive" class="md-check" type="checkbox" name="IsActive" [(ngModel)]="user.isActive">
                                <label for="EditUser_IsActive">
                            <span class="inc"></span>
                            <span class="check"></span>
                            <span class="box"></span>
                            {{l("Active")}}
                        </label>
                            </div>
                            <div class="md-checkbox" *ngIf="isTwoFactorEnabled">
                                <input id="EditUser_IsTwoFactorEnabled" class="md-check" type="checkbox" name="IsTwoFactorEnabled" [(ngModel)]="getUserForEdit.user.isTwoFactorEnabled">
                                <label for="EditUser_IsTwoFactorEnabled">
                            <span class="inc"></span>
                            <span class="check"></span>
                            <span class="box"></span>
                            {{l("IsTwoFactorEnabled")}}
                        </label>
                            </div>
                            <div class="md-checkbox" *ngIf="isLockoutEnabled">
                                <input id="EditUser_IsLockoutEnabled" class="md-check" type="checkbox" name="IsLockoutEnabled" [(ngModel)]="getUserForEdit.user.isLockoutEnabled">
                                <label for="EditUser_IsLockoutEnabled" tooltip="{{l('IsLockoutEnabled_Hint')}}">
                            <span class="inc"></span>
                            <span class="check"></span>
                            <span class="box"></span>
                            {{l("IsLockoutEnabled")}}
                        </label>
                            </div>
                        </div>

                    </tab>
                    <tab>
                        <ng-template tabHeading>
                            {{l('Roles')}} <b class="badge badge-primary">{{getAssignedRoleCount()}}</b>
                        </ng-template>

                        <div class="md-checkbox-list">
                            <div class="md-checkbox" *ngFor="let role of getUserForEdit.roles">
                                <input id="EditUser_{{role.roleName}}" class="md-check" type="checkbox" name="{{role.roleName}}" [(ngModel)]="role.isAssigned">
                                <label attr.for="EditUser_{{role.roleName}}">
                                    <span class="inc"></span>
                                    <span class="check"></span>
                                    <span class="box"></span>
                                    {{role.roleDisplayName}}
                                </label>
                            </div>
                        </div>
                    </tab>
                    <tab heading="{{l('Permissions')}}">
                        <div *ngIf="isShowPermission">
                            添加完用户后可修改
                        </div>
                        <div *ngIf="!isShowPermission">
                            <editUserPermissionsModal #editUserPermissionsModal [userId]='userId'></editUserPermissionsModal>
                        </div>
                    </tab>
                    <tab heading="{{l('ExternalLogin')}}">
                        <div *ngIf="isShowPermission">
                            添加完用户后可查看
                        </div>
                        <div *ngIf="!isShowPermission">
                            <div>
                                <form novalidate #myForm="ngForm">
                                    <kendo-grid [data]="getUserForEdit.externalLoginData | async" [pageSize]=" pageSize " [skip]="skip " [sort]="sort " [pageable]="true " [sortable]="false" (dataStateChange)="onStateChange($event)">
                                        <kendo-grid-column field="loginProvider " title="{{l( 'ExternalLoginMode')}} ">
                                            <ng-template let-dataItem="dataItem "></ng-template>
                                        </kendo-grid-column>
                                        <kendo-grid-column field="userName " title="{{l( 'ExternalLoginName')}} ">
                                            <ng-template let-dataItem="dataItem "></ng-template>
                                        </kendo-grid-column>
                                        <kendo-grid-column field="accessTokenOutDataTime " title="{{l( 'ExternalLoginTime')}} ">
                                            <ng-template let-dataItem="dataItem "></ng-template>
                                        </kendo-grid-column>
                                    </kendo-grid>
                                </form>
                            </div>
                        </div>
                    </tab>
                </tabset>
            </div>
        </div>
    </form>
</div>